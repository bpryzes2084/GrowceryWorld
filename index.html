<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Growceryworld â€” Giving You Choices</title>
  <meta name="description" content="Growceryworld â€” Giving you choices. Free item and free water bottle with every order." />

  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#475569; --border:#e5e7eb;
      --accent:#16a34a; --accentHover:#15803d; --btn:#111827; --btnHover:#0b1220;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    .wrap{max-width:1100px;margin:0 auto;padding:40px 20px}
    .top-nav{border-bottom:1px solid var(--border);padding:12px 20px;position:sticky;top:0;background:#fff;z-index:10}
    .top-nav-inner{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .nav-logo{font-weight:900;font-size:18px}
    .cart-btn{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}

    h2{margin:0 0 10px}

    .search-form{display:flex;gap:8px;margin-bottom:10px}
    .search-form input{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);outline:none}
    .search-form input:focus{border-color:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.25)}
    .search-form button{padding:12px 16px;border-radius:12px;border:0;background:var(--btn);color:#fff;font-weight:800;cursor:pointer}
    .search-form button:hover{background:var(--btnHover)}
    .search-form button:disabled{opacity:.6;cursor:not-allowed}
    .search-status{font-size:13px;color:var(--muted);margin-bottom:12px;min-height:18px}

    /* INFO CARDS */
    .info-cards{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
      margin:16px 0 28px;
    }
    .info-card{
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      display:flex;
      gap:12px;
      align-items:center;
      background:#fff;
    }
    .info-card img{width:56px;height:56px;object-fit:contain}
    .info-card h4{margin:0 0 4px;font-size:15px;font-weight:900}
    .info-card p{margin:0;font-size:13px;color:var(--muted)}
    @media(max-width:800px){ .info-cards{grid-template-columns:1fr} }

    /* RESULTS */
    .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .product-card{border:1px solid var(--border);border-radius:14px;padding:14px;background:#fff;transition:.15s}
    .product-card:hover{box-shadow:0 10px 24px rgba(0,0,0,.08);transform:translateY(-2px)}
    .product-image{width:100%;height:180px;object-fit:cover;border-radius:10px;margin-bottom:10px;background:#f1f5f9}
    .product-name{font-weight:900;font-size:15px;margin:0}
    .product-price{color:var(--accent);font-weight:900;margin:4px 0}
    .product-desc{font-size:13px;color:var(--muted);min-height:34px}
    .product-actions{margin-top:10px}
    .btn-add{width:100%;padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:900;cursor:pointer}
    .btn-add:hover{background:var(--accentHover)}
    .btn-add:disabled{opacity:.6;cursor:not-allowed}

    /* CART PANEL */
    .cart-panel{
      position:fixed;right:18px;top:72px;width:380px;max-width:92vw;
      background:#fff;border:1px solid var(--border);border-radius:12px;
      padding:12px;box-shadow:0 12px 40px rgba(2,6,23,.10);
      z-index:30;display:flex;flex-direction:column;gap:10px
    }
    .cart-hidden{display:none}
    .cart-item{display:flex;gap:10px;align-items:center;border-bottom:1px dashed #eee;padding-bottom:10px}
    .cart-item img{width:60px;height:50px;object-fit:cover;border-radius:6px;background:#f3f4f6}
    .cart-item .meta{flex:1}
    .cart-item .meta .name{font-weight:900;font-size:14px}
    .cart-item .meta .sub{font-size:12px;color:var(--muted)}
    .small-muted{font-size:13px;color:var(--muted)}
    .qty-input{width:64px;padding:6px;border-radius:6px;border:1px solid #e5e7eb}
    .checkout-btn{background:#111;color:#fff;padding:10px 12px;border-radius:10px;border:0;font-weight:900;cursor:pointer}
    .checkout-btn:disabled{opacity:.6;cursor:not-allowed}

    footer{text-align:center;color:var(--muted);font-size:13px;margin-top:40px}
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="top-nav-inner">
      <div class="nav-logo">Growceryworld</div>
      <button id="openCartBtn" class="cart-btn">ðŸ›’ Cart (<span id="cartCount">0</span>)</button>
    </div>
  </nav>

  <main class="wrap">
    <section>
      <h2>Search products</h2>
      <form id="gw-search" class="search-form" autocomplete="off">
        <input id="q" type="search" placeholder="Search cereal, chips, cleaning suppliesâ€¦" />
        <button id="go" type="submit">Search</button>
      </form>
      <div id="search-status" class="search-status"></div>
    </section>

    <!-- INFO CARDS -->
    <section class="info-cards">
      <div class="info-card">
        <img src="/images/free-item.png" alt="Free item">
        <div>
          <h4>Free item with every order</h4>
          <p>One free item per checkout (while supplies last).</p>
        </div>
      </div>

      <div class="info-card">
        <img src="/images/water-bottle.png" alt="Free water bottle">
        <div>
          <h4>Free bottle of water</h4>
          <p>Every order includes a complimentary water bottle.</p>
        </div>
      </div>

      <div class="info-card">
        <img src="/images/ups.png" alt="UPS shipping">
        <div>
          <h4>Orders shipped via UPS</h4>
          <p>Reliable delivery with tracking (rates at checkout).</p>
        </div>
      </div>
    </section>

    <section>
      <div id="results" class="results-grid"></div>
    </section>

    <footer>Â© <span id="year"></span> Growceryworld</footer>
  </main>

  <!-- CART PANEL -->
  <div id="cartPanel" class="cart-panel cart-hidden" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Your cart</strong>
      <button id="closeCart" style="background:transparent;border:0;cursor:pointer;font-size:18px">âœ•</button>
    </div>

    <div id="cartItemsContainer" style="display:flex;flex-direction:column;gap:10px"></div>

    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small-muted">Subtotal</div>
      <div id="cartSubtotal" class="small-muted">$0.00</div>
    </div>

    <div style="display:flex;gap:8px">
      <button id="checkoutBtn" class="checkout-btn" style="flex:1">Checkout</button>
      <button id="clearCartBtn" class="checkout-btn" style="background:#eee;color:#111">Clear</button>
    </div>

    <div id="checkoutStatus" class="small-muted" style="min-height:18px"></div>
  </div>

  <script>
    // ===== CONFIG =====
    // Your Worker is routed to /api/*
    const API_BASE = "/api";
    const SEARCH_ENDPOINT = `${API_BASE}/search`;
    const CHECKOUT_ENDPOINT = `${API_BASE}/create-checkout`; // Worker must implement this route

    document.getElementById("year").textContent = new Date().getFullYear();

    // ===== CART (localStorage) =====
    function formatMoney(n){ return "$" + Number(n).toFixed(2); }

    function getCart(){
      try { return JSON.parse(localStorage.getItem("gw_cart") || "[]"); }
      catch { return []; }
    }

    function saveCart(cart){
      localStorage.setItem("gw_cart", JSON.stringify(cart));
      updateCartUI();
    }

    function cartCount(){
      return getCart().reduce((sum,i)=> sum + (i.qty||0), 0);
    }

    function cartSubtotal(){
      return getCart().reduce((sum,i)=> sum + (Number(i.price||0) * (i.qty||1)), 0);
    }

    function addToCart(item){
      // item = { variationId, name, price, image }
      const cart = getCart();

      const existing = cart.find(x => x.variationId === item.variationId);
      if (existing) {
        existing.qty = Math.min(99, (existing.qty || 1) + 1);
      } else {
        cart.push({
          variationId: item.variationId,
          name: item.name,
          price: Number(item.price || 0),
          image: item.image || "",
          qty: 1
        });
      }
      saveCart(cart);
    }

    function removeFromCart(variationId){
      const cart = getCart().filter(i => i.variationId !== variationId);
      saveCart(cart);
    }

    function updateQty(variationId, qty){
      const cart = getCart();
      const it = cart.find(i => i.variationId === variationId);
      if (!it) return;
      it.qty = Math.max(0, Number(qty) || 0);
      if (it.qty <= 0) return removeFromCart(variationId);
      saveCart(cart);
    }

    function clearCart(){
      localStorage.removeItem("gw_cart");
      updateCartUI();
    }

    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function updateCartUI(){
      const countEl = document.getElementById("cartCount");
      const itemsEl = document.getElementById("cartItemsContainer");
      const subtotalEl = document.getElementById("cartSubtotal");
      const checkoutBtn = document.getElementById("checkoutBtn");

      const cart = getCart();
      countEl.textContent = cartCount();
      subtotalEl.textContent = formatMoney(cartSubtotal());

      itemsEl.innerHTML = "";

      if (!cart.length){
        itemsEl.innerHTML = `<div class="small-muted">Your cart is empty.</div>`;
        checkoutBtn.disabled = true;
        return;
      }

      cart.forEach(it => {
        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <img src="${it.image ? it.image : '/images/no-image.png'}" alt="${escapeHtml(it.name)}" onerror="this.style.display='none'">
          <div class="meta">
            <div class="name">${escapeHtml(it.name)}</div>
            <div class="sub">${formatMoney(it.price)}</div>
            <div class="sub" style="margin-top:6px">
              Qty:
              <input class="qty-input" type="number" min="0" value="${it.qty}" data-vid="${it.variationId}">
            </div>
          </div>
          <div style="text-align:right">
            <button data-remove="${it.variationId}" style="background:#fff;border:1px solid #e5e7eb;padding:6px 10px;border-radius:8px;cursor:pointer">
              Remove
            </button>
          </div>
        `;
        itemsEl.appendChild(div);
      });

      itemsEl.querySelectorAll(".qty-input").forEach(inp => {
        inp.addEventListener("change", () => updateQty(inp.dataset.vid, inp.value));
      });

      itemsEl.querySelectorAll("[data-remove]").forEach(btn => {
        btn.addEventListener("click", () => removeFromCart(btn.getAttribute("data-remove")));
      });

      checkoutBtn.disabled = false;
    }

    // Cart panel toggles
    document.getElementById("openCartBtn").addEventListener("click", () => {
      document.getElementById("cartPanel").classList.toggle("cart-hidden");
    });
    document.getElementById("closeCart").addEventListener("click", () => {
      document.getElementById("cartPanel").classList.add("cart-hidden");
    });
    document.getElementById("clearCartBtn").addEventListener("click", () => {
      clearCart();
      document.getElementById("checkoutStatus").textContent = "Cart cleared.";
    });

    // ===== CHECKOUT =====
    async function checkout(){
      const status = document.getElementById("checkoutStatus");
      status.textContent = "";
      const cart = getCart();
      if (!cart.length) { status.textContent = "Cart is empty."; return; }

      const checkoutBtn = document.getElementById("checkoutBtn");
      checkoutBtn.disabled = true;
      status.textContent = "Preparing checkoutâ€¦";

      // Payload uses variationId (Square wants variation catalog object ids)
      const payload = {
        items: cart.map(i => ({
          variationId: i.variationId,
          quantity: Number(i.qty || 1)
        }))
      };

      try {
        const res = await fetch(CHECKOUT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch { /* keep raw */ }

        if (!res.ok) {
          console.error("checkout error:", res.status, text);
          status.textContent = `Checkout failed: ${res.status}`;
          checkoutBtn.disabled = false;
          return;
        }

        // Expect { checkoutUrl: "https://..." }
        const checkoutUrl = data && data.checkoutUrl;
        if (!checkoutUrl) {
          status.textContent = "Checkout endpoint did not return checkoutUrl.";
          console.error("checkout response:", text);
          checkoutBtn.disabled = false;
          return;
        }

        // Optional: clear cart before redirect
        // clearCart();

        window.location.href = checkoutUrl;

      } catch (e) {
        console.error("checkout failed:", e);
        status.textContent = "Checkout failed. Check console.";
        checkoutBtn.disabled = false;
      }
    }

    document.getElementById("checkoutBtn").addEventListener("click", checkout);

    // ===== SEARCH + RENDER =====
    const form = document.getElementById("gw-search");
    const qInput = document.getElementById("q");
    const resultsDiv = document.getElementById("results");
    const statusEl = document.getElementById("search-status");
    const searchBtn = document.getElementById("go");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = qInput.value.trim();
      resultsDiv.innerHTML = "";
      statusEl.textContent = "";

      if (!q) { statusEl.textContent = "Type something to search your inventory."; return; }

      searchBtn.disabled = true;
      searchBtn.textContent = "Searchingâ€¦";
      statusEl.textContent = "Searchingâ€¦";

      try {
        const res = await fetch(`${SEARCH_ENDPOINT}?q=${encodeURIComponent(q)}`);
        if (!res.ok) {
          const t = await res.text();
          console.error("Search failed:", res.status, t);
          statusEl.textContent = "Search error. Check Worker /api/search.";
          return;
        }

        const data = await res.json();
        const items = (data.objects || []).filter(o => o.type === "ITEM");

        if (!items.length) {
          statusEl.textContent = "No items found.";
          return;
        }

        statusEl.textContent = `Found ${items.length} item(s).`;

        const frag = document.createDocumentFragment();

        items.forEach(obj => {
          const itemData = obj.item_data || {};
          const name = itemData.name || "Unnamed item";
          const desc = itemData.description || "";
          const image = obj.image_url || "";

          // Use FIRST variation for price + variationId
          const firstVar = itemData.variations?.[0];
          const variationId = firstVar?.id || null;
          const varData = firstVar?.item_variation_data || null;
          const priceMoney = varData?.price_money || null;
          const price = priceMoney ? (priceMoney.amount / 100) : null;

          const card = document.createElement("div");
          card.className = "product-card";

          card.innerHTML = `
            ${image ? `<img class="product-image" src="${image}" alt="${escapeHtml(name)}" onerror="this.style.display='none'">` : ""}
            <div class="product-name">${escapeHtml(name)}</div>
            <div class="product-price">${price != null ? formatMoney(price) : "Price N/A"}</div>
            <div class="product-desc">${escapeHtml(desc)}</div>
            <div class="product-actions">
              <button class="btn-add" ${!variationId ? "disabled" : ""}>
                ${variationId ? "Add to Cart" : "Missing variation"}
              </button>
            </div>
          `;

          const btn = card.querySelector(".btn-add");
          if (variationId) {
            btn.addEventListener("click", () => {
              addToCart({ variationId, name, price: (price != null ? price : 0), image });
              document.getElementById("checkoutStatus").textContent = `${name} added to cart âœ…`;
              // auto-open cart (optional)
              // document.getElementById("cartPanel").classList.remove("cart-hidden");
            });
          }

          frag.appendChild(card);
        });

        resultsDiv.appendChild(frag);

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Search error. Check console.";
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = "Search";
      }
    });

    // Init UI
    document.addEventListener("DOMContentLoaded", () => updateCartUI());
  </script>
</body>
</html>
