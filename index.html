<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Growceryworld â€” Giving You Choices</title>
  <meta name="description" content="Growceryworld â€” Giving you choices. No monthly membership fees. Free item with every order." />
  <meta name="robots" content="index,follow" />

  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#475569; --border:#e5e7eb;
      --accent2:#16a34a; --accent2Hover:#15803d; --btnDark:#111827; --btnDarkHover:#0b1220;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1100px;margin:0 auto;padding:48px 20px 80px}
    .top-nav{background:#fff;border-bottom:1px solid var(--border);padding:12px 20px;position:sticky;top:0;z-index:100;}
    .top-nav-inner{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:16px}
    .nav-logo{font-weight:800;font-size:18px;display:flex;align-items:center;gap:6px}
    .nav-links{display:flex;gap:16px;font-size:14px;color:var(--muted)}
    .nav-links a:hover{color:var(--ink)}

    .cart-btn{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:10px;color:var(--ink);cursor:pointer;display:flex;align-items:center;gap:8px}

    .section{margin:32px 0}
    .search-section{max-width:760px;margin:0 auto;text-align:left}
    .search-form{display:flex;gap:8px;margin-bottom:10px}
    .search-form input[type="search"]{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--ink);font-size:14px;outline:none;}
    .search-form input[type="search"]:focus{border-color:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.25);}
    .search-form input::placeholder{color:#94a3b8}
    .search-form button{padding:12px 16px;border-radius:12px;border:0;background:var(--btnDark);color:#fff;cursor:pointer;font-weight:700;font-size:14px;white-space:nowrap;}
    .search-form button:hover{background:var(--btnDarkHover)}
    .search-form button:disabled{opacity:.6;cursor:not-allowed}
    .search-status{font-size:13px;color:var(--muted);min-height:20px;margin-bottom:8px}

    .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;}
    .product-card{border:1px solid var(--border);border-radius:14px;padding:14px;background:#fff;color:var(--ink);transition:transform .18s,box-shadow .18s,border-color .18s;overflow:hidden;position:relative;}
    .product-card:hover{transform:translateY(-2px);border-color:#cbd5e1;box-shadow:0 10px 24px rgba(2,6,23,.08);}
    .product-image{width:100%;height:200px;object-fit:cover;border-radius:12px 12px 0 0;margin:-14px -14px 12px -14px;background:#f1f5f9;}
    .product-name{margin:0 0 6px;font-size:15px;font-weight:800}
    .product-price{margin:0;font-size:14px;font-weight:800;color:var(--accent2)}
    .product-desc{margin:8px 0 0;font-size:13px;color:var(--muted);min-height:34px}
    .product-actions{margin-top:10px}
    .btn-add{width:100%;padding:10px 16px;border-radius:10px;border:0;background:var(--accent2);color:#fff;cursor:pointer;font-size:14px;font-weight:800;transition:background .15s;font-family:inherit}
    .btn-add:hover{background:var(--accent2Hover)}

    footer{text-align:center;margin-top:40px;font-size:13px;color:var(--muted)}
    .coming-soon{text-align:center;margin-top:16px;font-size:13px;color:var(--muted)}

    @media(max-width:640px){
      .wrap{padding-inline:14px}
      .top-nav-inner{flex-wrap:wrap;justify-content:space-between}
      .nav-links{display:none}
    }

    /* cart panel */
    .cart-panel{position:fixed;right:18px;top:72px;width:360px;max-width:92vw;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 12px 40px rgba(2,6,23,.08);display:flex;flex-direction:column;gap:10px;z-index:300}
    .cart-hidden{display:none}
    .cart-item{display:flex;gap:10px;align-items:center;border-bottom:1px dashed #eee;padding-bottom:8px}
    .cart-item img{width:60px;height:50px;object-fit:cover;border-radius:6px;background:#f3f4f6}
    .cart-item .meta{flex:1}
    .cart-item .meta .name{font-weight:700;font-size:14px}
    .cart-item .meta .qty{font-size:13px;color:var(--muted)}
    .small-muted{font-size:13px;color:var(--muted)}
    .checkout-btn{background:#111;color:#fff;padding:10px 12px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .checkout-btn:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="top-nav-inner">
      <div class="nav-logo"><span>Growceryworld</span></div>

      <div class="nav-links">
        <a href="#search">Search</a>
      </div>

      <div style="display:flex;align-items:center;gap:8px">
        <button id="openCartBtn" class="cart-btn">ðŸ›’ Cart (<span id="cartCount">0</span>)</button>
      </div>
    </div>
  </nav>

  <main class="wrap">
    <section id="search" class="section search-section">
      <h2 style="font-size:20px;margin:0 0 8px;">Search products</h2>
      <p class="search-status" id="search-status"></p>
      <form id="gw-search" class="search-form" autocomplete="off">
        <input id="q" type="search" placeholder="Search by product name (e.g., cereal, Lysol, Dawn)..." aria-label="Search products" />
        <button type="submit" id="go">Search</button>
      </form>
      <div id="results" class="results-grid"></div>
    </section>

    <section class="section">
      <div class="coming-soon">Powered by Cloudflare Pages</div>
    </section>

    <footer>
      <p>&copy; <span id="year"></span> Growceryworld. All rights reserved.</p>
    </footer>
  </main>

  <!-- Cart panel (hidden by default) -->
  <div id="cartPanel" class="cart-panel cart-hidden" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Your cart</strong>
      <button id="closeCart" style="background:transparent;border:0;cursor:pointer">âœ•</button>
    </div>
    <div id="cartItemsContainer" style="display:flex;flex-direction:column;gap:8px"></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small-muted">Subtotal</div>
      <div id="cartSubtotal" class="small-muted">$0.00</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="checkoutBtn" class="checkout-btn" style="flex:1">Checkout</button>
      <button id="clearCartBtn" class="checkout-btn" style="background:#eee;color:#111">Clear</button>
    </div>
    <div id="checkoutStatus" class="small-muted" style="min-height:18px"></div>
  </div>

  <script>
    // ===== CONFIG =====
    const WORKER_URL = "https://gw-search.benterpryzes2084.workers.dev"; // /search
    const WORKER_CHECKOUT = "https://gw-search.benterpryzes2084.workers.dev/create-checkout"; // POST -> { checkoutUrl }

    // Inline placeholder (avoids via.placeholder.com DNS errors)
    const PLACEHOLDER_IMG =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="120" height="90">
          <rect width="100%" height="100%" fill="#f3f4f6"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                fill="#64748b" font-family="Arial" font-size="12">No image</text>
        </svg>
      `);

    // ===== Helpers & Cart storage =====
    function formatMoney(n){ return "$" + Number(n).toFixed(2); }
    function getCart(){ try{ return JSON.parse(localStorage.getItem("gw_cart") || "[]"); }catch{ return []; } }
    function saveCart(cart){ localStorage.setItem("gw_cart", JSON.stringify(cart)); updateCartUI(); }
    function cartCount(){ return getCart().reduce((s,i)=>s+(i.qty||0),0); }
    function cartSubtotal(){ return getCart().reduce((s,i)=> s+(Number(i.price||0)*(i.qty||1)),0); }
    function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    function addToCartObj(product){
      const cart = getCart();
      const found = cart.find(i => i.id === product.id);
      if(found){ found.qty = Math.min(99, (found.qty||1) + 1); }
      else{
        cart.push({
          id: product.id,
          name: product.name,
          price: Number(product.price||0),
          image: product.image||"",
          qty: 1,
          shippable: product.shippable !== false
        });
      }
      saveCart(cart);
    }

    function removeFromCart(id){
      const cart = getCart().filter(i => i.id !== id);
      saveCart(cart);
    }

    function updateQty(id, qty){
      const cart = getCart();
      const it = cart.find(i => i.id === id);
      if(!it) return;
      it.qty = Math.max(0, Number(qty));
      saveCart(cart);
    }

    function clearCart(){
      localStorage.removeItem("gw_cart");
      updateCartUI();
    }

    function updateCartUI(){
      const countEl = document.getElementById("cartCount");
      const itemsContainer = document.getElementById("cartItemsContainer");
      const subtotalEl = document.getElementById("cartSubtotal");
      const checkoutBtn = document.getElementById("checkoutBtn");

      const cart = getCart();
      countEl.textContent = cartCount();
      subtotalEl.textContent = formatMoney(cartSubtotal());

      itemsContainer.innerHTML = "";
      if(!cart.length){
        itemsContainer.innerHTML = '<div class="small-muted">Your cart is empty.</div>';
        checkoutBtn.disabled = true;
        return;
      }

      cart.forEach(it => {
        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <img src="${it.image ? it.image : PLACEHOLDER_IMG}" alt="${escapeHtml(it.name)}" />
          <div class="meta">
            <div class="name">${escapeHtml(it.name)}</div>
            <div class="qty">
              Qty:
              <input data-id="${it.id}" class="qty-input" type="number" value="${it.qty}" min="0"
                style="width:64px;padding:6px;border-radius:6px;border:1px solid #eee" />
            </div>
          </div>
          <div style="text-align:right">
            <div class="small-muted">${formatMoney(it.price)}</div>
            <div style="margin-top:8px">
              <button data-remove="${it.id}" style="background:#fff;border:1px solid #eee;padding:6px;border-radius:8px;cursor:pointer">
                Remove
              </button>
            </div>
          </div>
        `;
        itemsContainer.appendChild(div);
      });

      itemsContainer.querySelectorAll(".qty-input").forEach(inp=>{
        inp.addEventListener("change", ()=>{
          const id = inp.dataset.id;
          const val = Number(inp.value)||0;
          if(val <= 0) removeFromCart(id);
          else updateQty(id, val);
        });
      });

      itemsContainer.querySelectorAll("[data-remove]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-remove");
          removeFromCart(id);
        });
      });

      checkoutBtn.disabled = false;
    }

    // ===== Cart UI toggles =====
    document.getElementById("openCartBtn").addEventListener("click", ()=>{
      document.getElementById("cartPanel").classList.toggle("cart-hidden");
    });
    document.getElementById("closeCart").addEventListener("click", ()=>{
      document.getElementById("cartPanel").classList.add("cart-hidden");
    });
    document.getElementById("clearCartBtn").addEventListener("click", ()=>{
      clearCart();
      const st = document.getElementById("checkoutStatus");
      if(st) st.textContent = "Cart cleared";
    });

    // ===== Checkout via Worker =====
    async function checkout(){
      const checkoutStatus = document.getElementById("checkoutStatus");
      checkoutStatus.textContent = "";
      const cart = getCart();
      if(!cart.length){ checkoutStatus.textContent = "Cart is empty."; return; }

      document.getElementById("checkoutBtn").disabled = true;
      checkoutStatus.textContent = "Preparing checkoutâ€¦";

      const payload = {
        items: cart.map(i => ({
          id: i.id,
          name: i.name,
          price: Number(i.price||0),
          qty: Number(i.qty||1),
          shippable: !!i.shippable
        }))
      };

      try{
        const res = await fetch(WORKER_CHECKOUT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const text = await res.text();
          checkoutStatus.textContent = "Checkout failed: " + res.status;
          console.error("checkout error:", res.status, text);
          document.getElementById("checkoutBtn").disabled = false;
          return;
        }

        const data = await res.json();
        if(data.checkoutUrl){
          window.location.href = data.checkoutUrl;
        } else {
          checkoutStatus.textContent = "Checkout endpoint did not return a URL.";
          document.getElementById("checkoutBtn").disabled = false;
        }
      } catch(err){
        console.error("Checkout error:", err);
        checkoutStatus.textContent = "Checkout failed. See console.";
        document.getElementById("checkoutBtn").disabled = false;
      }
    }
    document.getElementById("checkoutBtn").addEventListener("click", checkout);

    // ===== Search & render products (Worker) =====
    const searchInput = document.getElementById("q");
    const searchBtn = document.getElementById("go");
    const resultsDiv = document.getElementById("results");
    const searchStatusEl = document.getElementById("search-status");

    async function performSearch(evt){
      if(evt) evt.preventDefault();
      const q = searchInput.value.trim();
      resultsDiv.innerHTML = "";
      searchStatusEl.textContent = "";
      if(!q){ searchStatusEl.textContent = "Type something to search your Square inventory."; return; }

      try{
        searchBtn.disabled = true; searchBtn.textContent = "Searchingâ€¦";
        const res = await fetch(WORKER_URL + "/search?q=" + encodeURIComponent(q));
        if(!res.ok){
          const t = await res.text();
          console.error("Search failed:", res.status, t);
          searchStatusEl.textContent = "Search error";
          return;
        }

        const data = await res.json();
        if(!Array.isArray(data.objects)){
          console.error("Unexpected search response", data);
          searchStatusEl.textContent = "Search error";
          return;
        }

        const objects = data.objects.filter(o => o.type === "ITEM");
        if(!objects.length){ searchStatusEl.textContent = "No items found"; return; }

        searchStatusEl.textContent = `Found ${objects.length} item(s).`;
        const frag = document.createDocumentFragment();

        objects.forEach(obj => {
          const itemData = obj.item_data || {};
          const variations = itemData.variations || [];
          const variation = variations[0]?.item_variation_data || null;
          const priceMoney = variation?.price_money || null;
          const price = priceMoney ? (priceMoney.amount / 100) : null;
          const image = obj.image_url || null;
          const id = obj.id;
          const name = itemData.name || "Unnamed item";
          const desc = itemData.description || "";

          const card = document.createElement("div");
          card.className = "product-card";

          if(image){
            const img = document.createElement("img");
            img.className = "product-image";
            img.loading = "lazy";
            img.src = image;
            img.alt = name;
            img.onerror = function(){ this.style.display = "none"; };
            card.appendChild(img);
          }

          const n = document.createElement("h3");
          n.className = "product-name";
          n.textContent = name;
          card.appendChild(n);

          const p = document.createElement("p");
          p.className = "product-price";
          p.textContent = price != null ? formatMoney(price) : "Price N/A";
          card.appendChild(p);

          const d = document.createElement("p");
          d.className = "product-desc";
          d.textContent = desc;
          card.appendChild(d);

          const actions = document.createElement("div");
          actions.className = "product-actions";

          const btn = document.createElement("button");
          btn.className = "btn-add";
          btn.textContent = "Add to Cart";
          btn.addEventListener("click", ()=>{
            addToCartObj({ id, name, price: (price != null ? price : 0), image });
          });
          actions.appendChild(btn);

          card.appendChild(actions);
          frag.appendChild(card);
        });

        resultsDiv.appendChild(frag);

      } catch(err){
        console.error("Search failed:", err);
        searchStatusEl.textContent = "Search failed. Check console.";
      } finally {
        searchBtn.disabled = false; searchBtn.textContent = "Search";
      }
    }

    document.getElementById("gw-search").addEventListener("submit", performSearch);

    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById("year").textContent = new Date().getFullYear();
      updateCartUI();
    });
  </script>
</body>
</html>
